name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      matrix:
        java: [17, 21]
        test-task: ["test40", "test41", "test50"]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v5
        with:
          java-version: ${{ matrix.java }}
          distribution: "temurin"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Run tests (${{ matrix.test-task }})
        run: ./gradlew ${{ matrix.test-task }}

  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: 17
          distribution: "temurin"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Run ktlint
        run: ./gradlew ktlintCheck

  detekt:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: 17
          distribution: "temurin"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Run detekt
        run: ./gradlew detekt

  kover:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: 17
          distribution: "temurin"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Run tests and generate coverage
        run: ./gradlew test koverXmlReport -x test40 -x test41 -x test50

  build-check:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [test, lint, detekt, kover]

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: 17
          distribution: "temurin"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Verify distTar builds successfully
        run: ./gradlew distTar

  build:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [test, lint, detekt, kover]
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: 17
          distribution: "temurin"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Build distribution tarball
        run: ./gradlew distTar

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        run: ./gradlew jib
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Upload distribution tarball
        uses: actions/upload-artifact@v5
        with:
          name: cassandra-easy-stress-latest
          path: build/distributions/*.tar.gz
          retention-days: 90
          if-no-files-found: error

  create-test-artifact:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: cassandra-easy-stress-latest
          path: artifacts

      - name: Prepare release file
        id: artifact
        run: |
          # Find the tarball and rename to consistent name
          ARTIFACT=$(find artifacts -name "*.tar.gz" -type f | head -n 1)

          if [[ -z "$ARTIFACT" ]]; then
            echo "ERROR: No tarball artifact found"
            exit 1
          fi

          echo "Found artifact: $ARTIFACT"

          # Rename to consistent name for stable URL
          TARGET_NAME="cassandra-easy-stress-latest.tar.gz"
          cp "$ARTIFACT" "$TARGET_NAME"

          # Verify file exists and is not empty
          if [[ ! -f "$TARGET_NAME" || ! -s "$TARGET_NAME" ]]; then
            echo "ERROR: Failed to create $TARGET_NAME"
            exit 1
          fi

          FILE_SIZE=$(du -h "$TARGET_NAME" | cut -f1)
          echo "Created $TARGET_NAME (size: $FILE_SIZE)"
          echo "artifact_path=$TARGET_NAME" >> $GITHUB_OUTPUT
          echo "artifact_size=$FILE_SIZE" >> $GITHUB_OUTPUT

      - name: Delete existing latest release
        continue-on-error: true
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release delete latest --yes --repo ${{ github.repository }} || true
          git push --delete origin latest || true

      - name: Publish test artifact
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: "Test Artifacts (Not an Official Release)"
          prerelease: true
          draft: false
          body: |
            ## ⚠️ Test Artifacts - Not an Official Release

            **This is NOT an official release.** These are automated test artifacts built from the `main` branch for testing and development purposes only.

            For official releases, see the [Releases page](https://github.com/${{ github.repository }}/releases).

            ### Download URL

            This URL always points to the latest test artifact from main:

            ```
            https://github.com/${{ github.repository }}/releases/download/latest/cassandra-easy-stress-latest.tar.gz
            ```

            ### Build Information

            - **Artifact Size**: ${{ steps.artifact.outputs.artifact_size }}
            - **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            - **Commit**: ${{ github.sha }}
            - **Java Version**: 17 (Temurin)

            ### Usage

            ```bash
            # Download and extract
            curl -L -o cassandra-easy-stress.tar.gz \
              https://github.com/${{ github.repository }}/releases/download/latest/cassandra-easy-stress-latest.tar.gz
            tar -xzf cassandra-easy-stress.tar.gz

            # Run
            cd cassandra-easy-stress-*/
            bin/cassandra-easy-stress --help
            ```

            ---

            **Warning**: These artifacts are for testing only and may contain unreleased, unstable, or experimental features.
          files: |
            cassandra-easy-stress-latest.tar.gz
